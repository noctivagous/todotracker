<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TodoTracker</title>
    
    <!-- Calcite Design System -->
    <link rel="stylesheet" href="https://js.arcgis.com/calcite-components/3.3.3/calcite.css">
    <script type="module" src="https://js.arcgis.com/calcite-components/3.3.3/calcite.esm.js"></script>
    <script nomodule src="https://js.arcgis.com/calcite-components/3.3.3/calcite.js"></script>
    
    <!-- Custom Calcite Components (extensions) -->
    <script src="/static/js/custom-calcite.js?v=20260120-01"></script>
    
    <!-- Marked for markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- DOMPurify for sanitizing rendered markdown -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.2.7/purify.min.js"></script>

    <!-- Toast UI Editor (WYSIWYG editor that can output Markdown) -->
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css">
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor-dark.min.css">
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
    
    <!-- Custom TodoTracker styles -->
    <link rel="stylesheet" href="/static/css/custom.css?v=20260120-01">

    <script>
      // Used by the client to cache-bust fetched template files under /static/templates/.
      window.TT_ASSET_VERSION = "20260120-01";
    </script>
    
    <script>
        // Set theme and layout width ASAP to avoid flash (default: light, full width)
        (function () {
            try {
                // Apply theme immediately (before body renders)
                var t = localStorage.getItem("tt-theme") || "light";
                // Apply to documentElement first since body may not exist yet
                var docEl = document.documentElement;
                docEl.classList.remove("calcite-mode-auto", "calcite-mode-light", "calcite-mode-dark");
                if (t === "dark") {
                    docEl.classList.add("calcite-mode-dark");
                } else {
                    docEl.classList.add("calcite-mode-light");
                }
                
                // Also apply to body if it exists
                var body = document.body;
                if (body) {
                    body.classList.remove("calcite-mode-auto", "calcite-mode-light", "calcite-mode-dark");
                    if (t === "dark") {
                        body.classList.add("calcite-mode-dark");
                    } else {
                        body.classList.add("calcite-mode-light");
                    }
                }
                
                // Apply layout width mode immediately to avoid flash
                var settingsKey = 'tt-settings-v1';
                var savedSettings = localStorage.getItem(settingsKey);
                if (savedSettings) {
                    try {
                        var settings = JSON.parse(savedSettings);
                        var widthMode = (settings && settings.layout && settings.layout.width_mode) ? String(settings.layout.width_mode) : 'max';
                        var maxWidthPx = (settings && settings.layout && settings.layout.max_width_px) ? parseInt(String(settings.layout.max_width_px), 10) : 1200;
                        if (!Number.isFinite(maxWidthPx)) maxWidthPx = 1100;
                        // snap to 100px increments + clamp
                        maxWidthPx = Math.round(maxWidthPx / 100) * 100;
                        if (maxWidthPx < 900) maxWidthPx = 900;
                        if (maxWidthPx > 2000) maxWidthPx = 2000;
                        docEl.style.setProperty('--tt-layout-maxwidth', String(maxWidthPx) + 'px');
                        if (widthMode === 'max') {
                            docEl.classList.add('tt-layout-maxwidth');
                        } else {
                            docEl.classList.remove('tt-layout-maxwidth');
                        }
                    } catch (e) {}
                }
            } catch (e) {}
        })();
    </script>
</head>
<body class="calcite-mode-auto">
    <calcite-shell>
        <!-- Master-detail panels (SPA) -->
        <calcite-shell-panel slot="panel-start" position="start" display-mode="dock" resizable id="tt-panel-start-shell">
            <div class="p-3" id="tt-panel-start"></div>
        </calcite-shell-panel>

        <calcite-shell-panel slot="panel-end" position="end" display-mode="dock" resizable collapsed id="tt-panel-end-shell">
            <div class="p-3" id="tt-panel-end"></div>
        </calcite-shell-panel>

        <!-- Header -->
        <header slot="header">
            <calcite-navigation>
                <calcite-button slot="logo" href="/todos" appearance="solid" kind="brand" scale="m" icon-start="check-square"
                    onclick="try{event&&event.preventDefault&&event.preventDefault(); if(window.router){ router.navigate('/todos'); } else { window.location.href='/todos'; }}catch(e){}">
                    TodoTracker
                </calcite-button>

                <div slot="content-start" class="tt-nav-actions">
                    <span id="projectNameChip" style="display: none;">
                        <calcite-chip appearance="outline" scale="s"></calcite-chip>
                    </span>

                    <!-- Global status filter (applies to left list + main view) -->
                    <calcite-segmented-control id="ttHeaderStatusSeg" class="tt-desktop-only" scale="s" value="pending">
                        <calcite-segmented-control-item value="all">All</calcite-segmented-control-item>
                        <calcite-segmented-control-item value="pending" checked>Pending</calcite-segmented-control-item>
                        <calcite-segmented-control-item value="in_progress">In Progress</calcite-segmented-control-item>
                        <calcite-segmented-control-item value="completed">Completed</calcite-segmented-control-item>
                        <calcite-segmented-control-item value="cancelled">Cancelled</calcite-segmented-control-item>
                        <calcite-segmented-control-item class="tt-seg-queue" value="queue" icon-start="list-check">Queue</calcite-segmented-control-item>
                    </calcite-segmented-control>

                    <calcite-select id="ttHeaderStatusSelect" class="tt-mobile-only" scale="s">
                        <calcite-option value="all">All</calcite-option>
                        <calcite-option value="pending" selected>Pending</calcite-option>
                        <calcite-option value="in_progress">In Progress</calcite-option>
                        <calcite-option value="completed">Completed</calcite-option>
                        <calcite-option value="cancelled">Cancelled</calcite-option>
                        <calcite-option value="queue">Queue</calcite-option>
                    </calcite-select>

                    <calcite-button id="ttHeaderNewTodoBtn" appearance="solid" scale="s" icon-start="plus">
                        New Todo
                    </calcite-button>
                </div>

                <!-- Restore navigation-secondary and place global search/filter controls here -->
                <calcite-navigation slot="navigation-secondary">
                    <div slot="content-start" class="tt-nav-secondary">
                        <calcite-segmented-control id="ttSpaNavTabs" class="tt-desktop-only" scale="s" value="todos">
                            <calcite-segmented-control-item value="todos" checked>Todos</calcite-segmented-control-item>
                            <calcite-segmented-control-item value="notes">Notes</calcite-segmented-control-item>
                        </calcite-segmented-control>

                        <calcite-select id="ttSpaNavSelect" class="tt-mobile-only" scale="s">
                            <calcite-option value="todos" selected>Todos</calcite-option>
                            <calcite-option value="notes">Notes</calcite-option>
                        </calcite-select>

                        <calcite-input id="ttNavSearchInput" type="text" placeholder="Search todos (Enter)..." scale="s" clearable></calcite-input>
                        <calcite-input id="ttNavFilterInput" type="text" placeholder="Filter (live)..." scale="s" clearable></calcite-input>

                        <!-- Notes-only filters (rendered by JS) -->
                        <div id="ttNotesNavFilters" class="tt-notes-nav-filters" hidden></div>
                    </div>
                </calcite-navigation>

                <!-- Settings (left of user placeholder) -->
                <calcite-button id="ttHeaderSettingsBtn" slot="content-end" appearance="transparent" scale="s" icon-start="gear" title="Settings">
                    Settings
                </calcite-button>
                <calcite-chip id="ttProjectNameChip" slot="content-end" scale="s" appearance="outline">Loading...</calcite-chip>
            </calcite-navigation>
        </header>

        <!-- Main Content -->
        <main id="app-content">
            <div class="p-6 tt-content-container">
                <calcite-loader id="app-loader" label="Loading" hidden></calcite-loader>
                <div id="app-view" style="display: none;"></div>
            </div>
        </main>
    </calcite-shell>

    <!-- jQuery (required for JsRender) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- JsRender/JsViews templating libraries -->
    <script src="/static/js/vendor/jsrender.min.js"></script>
    <script src="/static/js/vendor/jsviews.min.js"></script>

    <!-- Load application JavaScript -->
    <script src="/static/js/router.js?v=20260120-01"></script>
    <script src="/static/js/tt_md_editor.js?v=20260120-01"></script>
    <script src="/static/js/views/templates.js?v=20260120-01"></script>
    <script src="/static/js/views/core.js?v=20260120-01"></script>
    <script src="/static/js/views/todos.js?v=20260120-01"></script>
    <script src="/static/js/views/notes.js?v=20260120-01"></script>
    <script src="/static/js/app.js?v=20260120-01"></script>
    <script>
        // SPA nav "tabs" (uses clean routes: /todos, /notes)
        (function () {
            var tabs = document.getElementById("ttSpaNavTabs");
            var select = document.getElementById("ttSpaNavSelect");
            if (!tabs && !select) return;
            function getRoute() {
                try {
                    if (window.router && typeof window.router.getCurrentRoute === "function") {
                        return window.router.getCurrentRoute() || "/todos";
                    }
                } catch (e) {}
                try {
                    return window.location.pathname || "/todos";
                } catch (e2) {}
                return "/todos";
            }
            function syncFromRoute() {
                try {
                    var r = String(getRoute() || "");
                    var v = r.indexOf("/notes") === 0 ? "notes" : "todos";
                    // Calcite components may not be upgraded yet on first paint; apply a few times.
                    var apply = function () {
                        try { if (tabs) tabs.value = v; } catch (e) {}
                        try { if (select) select.value = v; } catch (e) {}
                    };
                    apply();
                    try { requestAnimationFrame(apply); } catch (e) { setTimeout(apply, 0); }
                    setTimeout(apply, 250);
                } catch (e) {}
            }
            function navigate() {
                try {
                    var val = (tabs && tabs.value) || (select && select.value);
                    if (window.router && typeof window.router.navigate === "function") {
                        window.router.navigate(val === "notes" ? "/notes" : "/todos");
                    } else {
                        window.location.href = val === "notes" ? "/notes" : "/todos";
                    }
                } catch (e) {}
            }
            syncFromRoute();
            window.addEventListener("tt-route-changed", syncFromRoute);
            window.addEventListener("popstate", syncFromRoute);
            window.addEventListener("load", syncFromRoute);
            try {
                if (window.customElements && window.customElements.whenDefined) {
                    Promise.all([
                        customElements.whenDefined("calcite-segmented-control"),
                        customElements.whenDefined("calcite-select")
                    ]).then(syncFromRoute);
                }
            } catch (e) {}
            if (tabs) {
                tabs.addEventListener("change", navigate);
                tabs.addEventListener("calciteSegmentedControlChange", navigate);
            }
            if (select) {
                select.addEventListener("change", navigate);
                select.addEventListener("calciteSelectChange", navigate);
            }
        })();
    </script>
</body>
</html>

