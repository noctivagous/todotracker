{% extends "base.html" %}

{% block title %}{{ todo.title }} - TodoTracker{% endblock %}

{% block content %}
{% set queue_relevant = todo.status.value in ['pending', 'in_progress'] %}
<div class="mb-6">
    <calcite-button href="/" appearance="outline">
        ‚Üê Back to todos
    </calcite-button>
</div>

<div id="ttTodoDetailRoot" data-todo-id="{{ todo.id }}">

<!-- Queue Switch and Priority/Task Size Controls at Top -->
<calcite-panel class="mb-4">
    <div slot="header">Todo Controls</div>
    <div class="flex items-center justify-between gap-4">
        <!-- Queue Switch -->
        <div>
            <form action="{% if queue_relevant and todo.queue and todo.queue > 0 %}/api/todos/{{ todo.id }}/queue/remove{% else %}/api/todos/{{ todo.id }}/queue/add{% endif %}" method="POST">
                <calcite-label>
                    <calcite-switch id="ttQueueSwitch"
                                    {% if queue_relevant and todo.queue and todo.queue > 0 %}checked{% endif %}
                                    {% if not queue_relevant %}disabled{% endif %}
                                    onchange="this.closest('form').submit()"></calcite-switch>
                    Queued
                    {% if queue_relevant and todo.queue and todo.queue > 0 %}
                        <span class="ml-2 font-semibold text-color-brand">(#{{ todo.queue }})</span>
                    {% endif %}
                </calcite-label>
            </form>
        </div>

        <!-- Priority and Task Size Controls -->
        <div class="flex gap-3 items-center">
            <!-- Priority Dropdown -->
            <calcite-label>
                Priority
                <calcite-select id="ttTopPrioritySelect" name="priority_class" scale="s">
                    <calcite-option value="" {% if not todo.priority_class %}selected{% endif %}></calcite-option>
                    {% for p in ['A','B','C','D','E'] %}
                        <calcite-option value="{{ p }}" {% if todo.priority_class == p %}selected{% endif %}>{{ p }}</calcite-option>
                    {% endfor %}
                </calcite-select>
            </calcite-label>

            <!-- Task Size Segmented Control -->
            <calcite-label>
                Task Size (1-5)
                <calcite-segmented-control id="ttTopTaskSizeSeg">
                    {% for s in range(1, 6) %}
                        <calcite-segmented-control-item value="{{ s }}"
                                                       {% if todo.task_size == s %}checked{% endif %}>
                            {{ s }}
                        </calcite-segmented-control-item>
                    {% endfor %}
                </calcite-segmented-control>
            </calcite-label>
        </div>
    </div>
</calcite-panel>

<calcite-card class="mb-6">
    <div class="flex justify-between items-start mb-4">
        <div class="flex-1">
            <!-- Title - Inline Editable -->
            <div class="mb-2">
                <h2 id="titleDisplay" class="text-3xl font-bold">{{ todo.title }}</h2>
                <calcite-input type="text"
                               id="titleInput"
                               name="title"
                               value="{{ todo.title }}"
                               scale="l"
                               class="hidden"
                               style="width: 100%;">
                </calcite-input>
            </div>

            <!-- Description - Inline Editable (directly beneath title) -->
            <div class="mb-4">
                <h3 class="text-sm font-semibold text-muted-foreground mb-2">Description</h3>
                <div id="descriptionDisplay" class="{% if not todo.description %}text-muted-foreground italic{% endif %} markdown-render">
                    {{ todo.description or 'No description' }}
                </div>
                <calcite-text-area id="descriptionInput" name="description" rows="6" class="hidden">
                    {{ todo.description or '' }}
                </calcite-text-area>
            </div>
            
            <!-- Category and Tags - Inline Editable -->
            <div class="flex flex-wrap gap-2 mb-4">
                <calcite-chip appearance="solid" scale="s" class="status-{{ todo.status.value }}">
                    {{ todo.status.value.replace('_', ' ') }}
                </calcite-chip>

                <!-- Category Display -->
                <calcite-chip id="categoryDisplay" appearance="outline" scale="s" class="category-{{ todo.category.value }}">
                    {{ todo.category.value }}
                </calcite-chip>
                <!-- Category Edit -->
                <calcite-select id="categoryInput" name="category" class="hidden" scale="s">
                    {% for cat in categories %}
                        <calcite-option value="{{ cat }}" {% if cat == todo.category.value %}selected{% endif %}>{{ cat }}</calcite-option>
                    {% endfor %}
                </calcite-select>
                
                <!-- Topic Display -->
                {% if todo.topic %}
                <calcite-chip id="topicDisplay" appearance="outline" scale="s" icon-start="folder">
                    {{ todo.topic }}
                </calcite-chip>
                {% else %}
                <calcite-chip id="topicDisplay" appearance="outline" scale="s" icon-start="folder" class="hidden"></calcite-chip>
                {% endif %}
                <!-- Topic Edit -->
                <div id="topicEdit" class="hidden">
                    <calcite-input type="text"
                                   id="topicInput"
                                   name="topic"
                                   value="{{ todo.topic or '' }}"
                                   placeholder="Topic"
                                   scale="s">
                    </calcite-input>
                    <datalist id="topicListDetail"></datalist>
                </div>
                
                <!-- Tags Display -->
                <div id="tagsDisplay" class="flex flex-wrap gap-2">
                    {% for tag in todo.tags %}
                    <calcite-chip appearance="outline" scale="s" icon-start="tag">
                        {{ tag.name }}
                    </calcite-chip>
                    {% endfor %}
                </div>
                <!-- Tags Edit -->
                <div id="tagsEdit" class="hidden">
                    <calcite-input type="text"
                                   id="tagsInput"
                                   name="tags"
                                   value="{{ todo.tags | map(attribute='name') | join(', ') }}"
                                   placeholder="Tags (comma-separated)"
                                   scale="s">
                    </calcite-input>
                    <div id="tagSuggestionsDetail" class="mt-2 flex flex-wrap gap-2"></div>
                </div>
            </div>
            
            <!-- Status Change Control -->
            <div class="mb-4">
                <calcite-label>
                    Status
                    <calcite-segmented-control id="ttDetailStatusSeg" scale="s">
                        {% for stat in statuses %}
                        <calcite-segmented-control-item value="{{ stat }}" {% if stat == todo.status.value %}checked{% endif %}>
                            {{ stat.replace('_', ' ') }}
                        </calcite-segmented-control-item>
                        {% endfor %}
                    </calcite-segmented-control>
                </calcite-label>
            </div>

            <!-- Execution & Priority -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-muted-foreground mb-2">Execution & Priority</label>
                <div class="flex flex-wrap gap-3 items-center">
                    <!-- Queue -->
                    <div>
                        <span class="text-sm text-muted-foreground font-semibold">Queue:</span>
                        <span id="queueDisplay" class="text-sm">
                            {% if queue_relevant and todo.queue and todo.queue > 0 %}{{ todo.queue }}{% else %}0 (not queued){% endif %}
                            {% if not queue_relevant %}<span class="text-color-3"> (disabled for this status)</span>{% endif %}
                        </span>
                        <calcite-input type="number"
                                       min="0"
                                       id="queueInput"
                                       name="queue"
                                       value="{% if queue_relevant %}{{ todo.queue or 0 }}{% else %}0{% endif %}"
                                       {% if not queue_relevant %}disabled{% endif %}
                                       scale="s"
                                       class="hidden"
                                       style="width: 7rem;">
                        </calcite-input>
                    </div>

                    <!-- Task Size -->
                    <div>
                        <calcite-label>
                            Task size
                            <calcite-segmented-control scale="s" id="ttDetailTaskSizeSeg">
                                {% for s in range(1, 6) %}
                                <calcite-segmented-control-item value="{{ s }}" {% if todo.task_size == s %}checked{% endif %}>
                                    {{ s }}
                                </calcite-segmented-control-item>
                                {% endfor %}
                            </calcite-segmented-control>
                        </calcite-label>
                        <input type="hidden" id="taskSizeInput" name="task_size" value="{{ todo.task_size or '' }}">
                    </div>

                    <!-- Priority Class -->
                    <div>
                        <span class="text-sm text-muted-foreground font-semibold">Priority:</span>
                        <span id="priorityClassDisplay" class="text-sm">
                            {% if todo.priority_class %}{{ todo.priority_class }}{% else %}‚Äî{% endif %}
                        </span>
                        <calcite-select id="priorityClassInput" name="priority_class" class="hidden" scale="s" style="width: 7rem;">
                            <calcite-option value="" {% if not todo.priority_class %}selected{% endif %}>‚Äî</calcite-option>
                            {% for p in ['A','B','C','D','E'] %}
                                <calcite-option value="{{ p }}" {% if todo.priority_class == p %}selected{% endif %}>{{ p }}</calcite-option>
                            {% endfor %}
                        </calcite-select>
                    </div>
                </div>
            </div>
        </div>
        <!-- Update Toggle Button - Top Right -->
        <div class="ml-4 flex flex-col items-end">
            <calcite-button id="toggleEditBtn" onclick="toggleEditMode()"
                            appearance="solid" kind="brand" scale="s" class="mb-2">
                Update Todo
            </calcite-button>
            <!-- Save Button (hidden by default) -->
            <div id="saveCancelButtons" class="hidden">
                <calcite-button onclick="saveChanges()" appearance="solid" kind="brand" scale="s" width="full">
                    Save Changes
                </calcite-button>
            </div>
        </div>
    </div>
    
    <!-- Progress Tracking (AI and User) - Always shown, inline editable - Horizontal Layout -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <!-- Work Completed -->
        <calcite-card>
            <h3 class="text-sm font-semibold mb-2">‚úÖ Work Completed</h3>
            <div id="workCompletedDisplay" class="{% if not todo.work_completed %}text-muted-foreground italic{% endif %} markdown-render">
                {{ todo.work_completed or 'No work completed yet' }}
            </div>
            <calcite-text-area id="workCompletedInput" name="work_completed" rows="5" class="hidden">
                {{ todo.work_completed or '' }}
            </calcite-text-area>
        </calcite-card>
        
        <!-- Work Remaining -->
        <calcite-card>
            <h3 class="text-sm font-semibold mb-2">üìã Work Remaining</h3>
            <div id="workRemainingDisplay" class="{% if not todo.work_remaining %}text-muted-foreground italic{% endif %} markdown-render">
                {{ todo.work_remaining or 'No remaining work specified' }}
            </div>
            <calcite-text-area id="workRemainingInput" name="work_remaining" rows="5" class="hidden">
                {{ todo.work_remaining or '' }}
            </calcite-text-area>
        </calcite-card>
        
        <!-- Implementation Issues -->
        <calcite-card>
            <h3 class="text-sm font-semibold mb-2">‚ö†Ô∏è Implementation Issues</h3>
            <div id="implementationIssuesDisplay" class="{% if not todo.implementation_issues %}text-muted-foreground italic{% endif %} markdown-render">
                {{ todo.implementation_issues or 'No implementation issues' }}
            </div>
            <calcite-text-area id="implementationIssuesInput" name="implementation_issues" rows="5" class="hidden">
                {{ todo.implementation_issues or '' }}
            </calcite-text-area>
        </calcite-card>
    </div>
    
    <div class="text-sm text-muted-foreground mb-4">
        <div class="flex items-center gap-3 flex-wrap">
            <div>Created: {{ todo.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
            <div>Updated: {{ todo.updated_at.strftime('%Y-%m-%d %H:%M') }}</div>
            <div class="flex items-center gap-1">
                <span>ID: #{{ todo.id }}</span>
                <calcite-button appearance="transparent"
                                scale="s"
                                icon-start="copy"
                                title="Copy todo ID to clipboard"
                                id="copyBtn">
                </calcite-button>
            </div>
        </div>
        {% if todo.parent_id %}
            <div class="mt-1">Parent: <a href="/todo/{{ todo.parent_id }}" class="underline underline-offset-2">#{{ todo.parent_id }}</a></div>
        {% endif %}
    </div>
    
    <!-- Hidden form for submission -->
    <form id="updateForm" action="/api/todos/{{ todo.id }}/update" method="POST" style="display: none;">
        <input type="hidden" id="formTitle" name="title" value="{{ todo.title }}">
        <input type="hidden" id="formDescription" name="description" value="{{ todo.description or '' }}">
        <input type="hidden" id="formCategory" name="category" value="{{ todo.category.value }}">
        <input type="hidden" id="formTopic" name="topic" value="{{ todo.topic or '' }}">
        <input type="hidden" id="formTags" name="tags" value="{{ todo.tags | map(attribute='name') | join(', ') }}">
        <input type="hidden" id="formWorkCompleted" name="work_completed" value="{{ todo.work_completed or '' }}">
        <input type="hidden" id="formWorkRemaining" name="work_remaining" value="{{ todo.work_remaining or '' }}">
        <input type="hidden" id="formImplementationIssues" name="implementation_issues" value="{{ todo.implementation_issues or '' }}">
        <input type="hidden" id="formQueue" name="queue" value="{% if queue_relevant %}{{ todo.queue or 0 }}{% else %}0{% endif %}">
        <input type="hidden" id="formTaskSize" name="task_size" value="{{ todo.task_size or '' }}">
        <input type="hidden" id="formPriorityClass" name="priority_class" value="{{ todo.priority_class or '' }}">
    </form>
</calcite-card>

<!-- Subtasks -->
{% if todo.children %}
<calcite-card class="mb-6">
    <h3 class="text-xl font-bold mb-4">Subtasks ({{ todo.children|length }})</h3>
    <div class="space-y-3">
        {% for child in todo.children %}
        <div class="todo-item {{ child.status.value }} tt-surface p-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <a href="/todo/{{ child.id }}" class="font-semibold underline underline-offset-2">
                        {{ child.title }}
                    </a>
                    <calcite-chip appearance="solid" scale="s" class="status-{{ child.status.value }}">
                        {{ child.status.value.replace('_', ' ') }}
                    </calcite-chip>
                    <calcite-chip appearance="outline" scale="s" class="category-{{ child.category.value }}">
                        {{ child.category.value }}
                    </calcite-chip>
                </div>
                <calcite-button href="/todo/{{ child.id }}" appearance="outline" scale="s">View</calcite-button>
            </div>
        </div>
        {% endfor %}
    </div>
</calcite-card>
{% endif %}

<!-- Notes -->
<calcite-card>
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Notes ({{ todo.notes|length }})</h3>
            <calcite-button onclick="document.getElementById('noteForm').classList.toggle('hidden')"
                            appearance="solid"
                            kind="brand"
                            scale="s"
                            icon-start="plus">
                Add Note
            </calcite-button>
        </div>
    
        <form id="noteForm" action="/api/notes/form" method="POST" class="hidden mb-4 space-y-2">
            <calcite-text-area name="content" rows="3" placeholder="Write a note..." required></calcite-text-area>
            <input type="hidden" name="todo_id" value="{{ todo.id }}">
            <calcite-button type="submit" appearance="solid" kind="brand">Add Note</calcite-button>
        </form>
    
        {% if todo.notes %}
            <div class="space-y-3">
                {% for note in todo.notes %}
                <div class="tt-surface p-4">
                    <div class="flex justify-between items-start gap-3">
                        <div class="flex-1 markdown-render">{{ note.content }}</div>
                        <form action="/api/notes/{{ note.id }}/delete" method="POST"
                              onsubmit="return confirm('Delete this note?')">
                            <calcite-button type="submit" appearance="solid" kind="danger" scale="s">Delete</calcite-button>
                        </form>
                    </div>
                    <div class="text-xs text-muted-foreground mt-2">
                        {{ note.created_at.strftime('%Y-%m-%d %H:%M') }}
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-muted-foreground text-sm">No notes yet.</p>
        {% endif %}
</calcite-card>

<script>
let isEditMode = false;
let originalValues = {};

function isQueueRelevantStatus(status) {
    const s = (status || '').toString();
    return s === 'pending' || s === 'in_progress';
}

function getCurrentStatusValue() {
    const statusSeg = document.getElementById('ttDetailStatusSeg');
    return (statusSeg && statusSeg.value ? statusSeg.value.toString() : '{{ todo.status.value }}');
}

function applyQueueRelevanceUI(status) {
    const relevant = isQueueRelevantStatus(status);

    const queueSwitch = document.getElementById('ttQueueSwitch');
    if (queueSwitch) {
        if (!relevant) {
            queueSwitch.checked = false;
        }
        queueSwitch.disabled = !relevant;
    }

    const queueInput = document.getElementById('queueInput');
    if (queueInput) {
        if (!relevant) {
            queueInput.value = '0';
        }
        queueInput.disabled = !relevant;
    }

    const formQueue = document.getElementById('formQueue');
    if (formQueue && !relevant) {
        formQueue.value = '0';
    }

    const queueDisplay = document.getElementById('queueDisplay');
    if (queueDisplay && !relevant) {
        // Keep the display consistent even if a stale queued value was present.
        const baseText = '0 (not queued)';
        queueDisplay.innerHTML = baseText + ' <span class="text-color-3">(disabled for this status)</span>';
    }
}

// Update todo field via AJAX (for dropdowns at top of page)
async function updateTodoFieldDetail(todoId, fieldName, fieldValue) {
    const formData = new FormData();
    formData.append(fieldName, fieldValue);
    
    try {
        const response = await fetch(`/api/todos/${todoId}/update`, {
            method: 'POST',
            body: formData,
            redirect: 'manual' // Don't follow redirect, we'll reload instead
        });
        
        // Any success status (2xx) or redirect (3xx) means the update worked
        if (response.ok || response.status === 303 || response.status === 302) {
            // Success - reload the page to show updated values
            window.location.reload();
        } else {
            console.error('Failed to update todo:', response.statusText);
            // Revert on error by reloading
            window.location.reload();
        }
    } catch (error) {
        console.error('Error updating todo:', error);
        // Revert on error by reloading
        window.location.reload();
    }
}

// Toggle edit mode
function toggleEditMode() {
    isEditMode = !isEditMode;
    
    if (isEditMode) {
        // Enter edit mode
        enterEditMode();
    } else {
        // Exit edit mode
        exitEditMode();
    }
}

// Enter edit mode
function enterEditMode() {
    // Store original values
    originalValues = {
        title: document.getElementById('titleInput').value,
        description: document.getElementById('descriptionInput').value,
        category: document.getElementById('categoryInput').value,
        topic: document.getElementById('topicInput').value,
        tags: document.getElementById('tagsInput').value,
        workCompleted: document.getElementById('workCompletedInput').value,
        workRemaining: document.getElementById('workRemainingInput').value,
        implementationIssues: document.getElementById('implementationIssuesInput').value,
        queue: document.getElementById('queueInput').value,
        taskSize: (() => {
            const display = document.getElementById('taskSizeDisplay');
            if (display) {
                const activeBtn = display.querySelector('.tt-segmented-control button.active');
                return activeBtn ? activeBtn.textContent.trim() : '';
            }
            return document.getElementById('taskSizeInput').value;
        })(),
        priorityClass: document.getElementById('priorityClassInput').value
    };
    
    // Hide display elements, show input elements
    document.getElementById('titleDisplay').classList.add('hidden');
    document.getElementById('titleInput').classList.remove('hidden');
    
    document.getElementById('descriptionDisplay').classList.add('hidden');
    document.getElementById('descriptionInput').classList.remove('hidden');
    
    document.getElementById('categoryDisplay').classList.add('hidden');
    document.getElementById('categoryInput').classList.remove('hidden');
    
    // Topic
    const topicDisplay = document.getElementById('topicDisplay');
    const topicEdit = document.getElementById('topicEdit');
    if (topicDisplay) {
        topicDisplay.classList.add('hidden');
    }
    topicEdit.classList.remove('hidden');
    
    // Tags
    document.getElementById('tagsDisplay').classList.add('hidden');
    document.getElementById('tagsEdit').classList.remove('hidden');
    
    // Progress tracking
    document.getElementById('workCompletedDisplay').classList.add('hidden');
    document.getElementById('workCompletedInput').classList.remove('hidden');
    
    document.getElementById('workRemainingDisplay').classList.add('hidden');
    document.getElementById('workRemainingInput').classList.remove('hidden');
    
    document.getElementById('implementationIssuesDisplay').classList.add('hidden');
    document.getElementById('implementationIssuesInput').classList.remove('hidden');

    // Execution & priority
    document.getElementById('queueDisplay').classList.add('hidden');
    document.getElementById('queueInput').classList.remove('hidden');
    applyQueueRelevanceUI(getCurrentStatusValue());
    // Task size uses segmented control, no need to toggle
    // document.getElementById('taskSizeDisplay').classList.add('hidden');
    // document.getElementById('taskSizeInput').classList.remove('hidden');
    document.getElementById('priorityClassDisplay').classList.add('hidden');
    document.getElementById('priorityClassInput').classList.remove('hidden');
    
    // Update button text and show save/cancel
    const toggleBtn = document.getElementById('toggleEditBtn');
    if (toggleBtn) {
        toggleBtn.textContent = 'Cancel Edit';
        toggleBtn.setAttribute('appearance', 'outline');
        toggleBtn.setAttribute('kind', 'neutral');
    }
    document.getElementById('saveCancelButtons').classList.remove('hidden');
}

// Exit edit mode
function exitEditMode() {
    // Restore original values to inputs (discard any changes)
    document.getElementById('titleInput').value = originalValues.title;
    document.getElementById('descriptionInput').value = originalValues.description;
    document.getElementById('categoryInput').value = originalValues.category;
    document.getElementById('topicInput').value = originalValues.topic;
    document.getElementById('tagsInput').value = originalValues.tags;
    document.getElementById('workCompletedInput').value = originalValues.workCompleted;
    document.getElementById('workRemainingInput').value = originalValues.workRemaining;
    document.getElementById('implementationIssuesInput').value = originalValues.implementationIssues;
    document.getElementById('queueInput').value = originalValues.queue;
    applyQueueRelevanceUI(getCurrentStatusValue());
    // Task size uses segmented control, update active state via JavaScript
    // document.getElementById('taskSizeInput').value = originalValues.taskSize;
    document.getElementById('priorityClassInput').value = originalValues.priorityClass;
    
    // Update display values from inputs (now restored to originals)
    updateDisplayValues();
    
    // Show display elements, hide input elements
    document.getElementById('titleDisplay').classList.remove('hidden');
    document.getElementById('titleInput').classList.add('hidden');
    
    document.getElementById('descriptionDisplay').classList.remove('hidden');
    document.getElementById('descriptionInput').classList.add('hidden');
    
    document.getElementById('categoryDisplay').classList.remove('hidden');
    document.getElementById('categoryInput').classList.add('hidden');
    
    // Topic
    const topicDisplay = document.getElementById('topicDisplay');
    const topicEdit = document.getElementById('topicEdit');
    topicEdit.classList.add('hidden');
    
    // Tags
    document.getElementById('tagsDisplay').classList.remove('hidden');
    document.getElementById('tagsEdit').classList.add('hidden');
    
    // Progress tracking
    document.getElementById('workCompletedDisplay').classList.remove('hidden');
    document.getElementById('workCompletedInput').classList.add('hidden');
    
    document.getElementById('workRemainingDisplay').classList.remove('hidden');
    document.getElementById('workRemainingInput').classList.add('hidden');
    
    document.getElementById('implementationIssuesDisplay').classList.remove('hidden');
    document.getElementById('implementationIssuesInput').classList.add('hidden');

    // Execution & priority
    document.getElementById('queueDisplay').classList.remove('hidden');
    document.getElementById('queueInput').classList.add('hidden');
    // Task size uses segmented control, always visible
    // document.getElementById('taskSizeDisplay').classList.remove('hidden');
    // document.getElementById('taskSizeInput').classList.add('hidden');
    document.getElementById('priorityClassDisplay').classList.remove('hidden');
    document.getElementById('priorityClassInput').classList.add('hidden');
    
    // Update button text and hide save/cancel
    const toggleBtn = document.getElementById('toggleEditBtn');
    if (toggleBtn) {
        toggleBtn.textContent = 'Update Todo';
        toggleBtn.setAttribute('appearance', 'solid');
        toggleBtn.setAttribute('kind', 'brand');
    }
    document.getElementById('saveCancelButtons').classList.add('hidden');
}

// Save changes
function saveChanges() {
    // Update form values
    document.getElementById('formTitle').value = document.getElementById('titleInput').value;
    document.getElementById('formDescription').value = document.getElementById('descriptionInput').value;
    document.getElementById('formCategory').value = document.getElementById('categoryInput').value;
    document.getElementById('formTopic').value = document.getElementById('topicInput').value;
    document.getElementById('formTags').value = document.getElementById('tagsInput').value;
    document.getElementById('formWorkCompleted').value = document.getElementById('workCompletedInput').value;
    document.getElementById('formWorkRemaining').value = document.getElementById('workRemainingInput').value;
    document.getElementById('formImplementationIssues').value = document.getElementById('implementationIssuesInput').value;
    const currentStatus = getCurrentStatusValue();
    document.getElementById('formQueue').value = isQueueRelevantStatus(currentStatus) ? document.getElementById('queueInput').value : '0';
    // Get task size from Calcite segmented control (or hidden input fallback)
    const taskSizeSeg = document.getElementById('ttDetailTaskSizeSeg');
    let taskSizeValue = '';
    if (taskSizeSeg) {
        taskSizeValue = (taskSizeSeg.value || '').toString().trim();
    }
    if (!taskSizeValue) taskSizeValue = (document.getElementById('taskSizeInput').value || '').trim();
    document.getElementById('formTaskSize').value = taskSizeValue;
    document.getElementById('formPriorityClass').value = document.getElementById('priorityClassInput').value;
    
    // Submit form
    document.getElementById('updateForm').submit();
}


    // Update display values from inputs
function updateDisplayValues() {
    document.getElementById('titleDisplay').textContent = document.getElementById('titleInput').value;
    
    const desc = document.getElementById('descriptionInput').value;
    const descDisplay = document.getElementById('descriptionDisplay');
    if (desc.trim()) {
        descDisplay.textContent = desc;
        descDisplay.classList.remove('text-muted-foreground', 'italic');
        renderMarkdown(descDisplay);
    } else {
        descDisplay.textContent = 'No description';
        descDisplay.classList.add('text-muted-foreground', 'italic');
        descDisplay.classList.remove('markdown-content');
    }
    
    // Update category display
    const categoryValue = document.getElementById('categoryInput').value;
    const categoryDisplay = document.getElementById('categoryDisplay');
    categoryDisplay.textContent = categoryValue;
    categoryDisplay.className = 'category-' + categoryValue;
    
    // Update topic display
    const topicValue = document.getElementById('topicInput').value.trim();
    const topicDisplay = document.getElementById('topicDisplay');
    if (topicValue) {
        topicDisplay.textContent = topicValue;
        topicDisplay.classList.remove('hidden');
    } else {
        topicDisplay.classList.add('hidden');
    }
    
    // Update tags display
    const tagsValue = document.getElementById('tagsInput').value;
    const tagsDisplay = document.getElementById('tagsDisplay');
    if (tagsValue.trim()) {
        const tags = tagsValue.split(',').map(t => t.trim()).filter(t => t);
        tagsDisplay.innerHTML = tags.map(tag =>
            `<calcite-chip appearance="outline" scale="s" icon-start="tag">${tag}</calcite-chip>`
        ).join('');
    } else {
        tagsDisplay.innerHTML = '';
    }
    
    // Update progress tracking displays
    const workCompleted = document.getElementById('workCompletedInput').value;
    const workCompletedDisplay = document.getElementById('workCompletedDisplay');
    if (workCompleted.trim()) {
        workCompletedDisplay.textContent = workCompleted;
        workCompletedDisplay.classList.remove('text-muted-foreground', 'italic');
        renderMarkdown(workCompletedDisplay);
    } else {
        workCompletedDisplay.textContent = 'No work completed yet';
        workCompletedDisplay.classList.add('text-muted-foreground', 'italic');
        workCompletedDisplay.classList.remove('markdown-content');
    }
    
    const workRemaining = document.getElementById('workRemainingInput').value;
    const workRemainingDisplay = document.getElementById('workRemainingDisplay');
    if (workRemaining.trim()) {
        workRemainingDisplay.textContent = workRemaining;
        workRemainingDisplay.classList.remove('text-muted-foreground', 'italic');
        renderMarkdown(workRemainingDisplay);
    } else {
        workRemainingDisplay.textContent = 'No remaining work specified';
        workRemainingDisplay.classList.add('text-muted-foreground', 'italic');
        workRemainingDisplay.classList.remove('markdown-content');
    }
    
    const implementationIssues = document.getElementById('implementationIssuesInput').value;
    const implementationIssuesDisplay = document.getElementById('implementationIssuesDisplay');
    if (implementationIssues.trim()) {
        implementationIssuesDisplay.textContent = implementationIssues;
        implementationIssuesDisplay.classList.remove('text-muted-foreground', 'italic');
        renderMarkdown(implementationIssuesDisplay);
    } else {
        implementationIssuesDisplay.textContent = 'No implementation issues';
        implementationIssuesDisplay.classList.add('text-muted-foreground', 'italic');
        implementationIssuesDisplay.classList.remove('markdown-content');
    }

    // Update execution & priority displays
    const queueVal = (document.getElementById('queueInput').value || '').trim();
    const queueDisplay = document.getElementById('queueDisplay');
    if (queueVal && parseInt(queueVal, 10) > 0) {
        queueDisplay.textContent = parseInt(queueVal, 10);
    } else {
        queueDisplay.textContent = '0 (not queued)';
    }

    // Task size segmented control reflects server state; keep hidden input in sync for saveChanges fallback
    const taskSizeSeg = document.getElementById('ttDetailTaskSizeSeg');
    if (taskSizeSeg) {
        document.getElementById('taskSizeInput').value = (taskSizeSeg.value || '').toString();
    }

    const priorityVal = (document.getElementById('priorityClassInput').value || '').trim();
    const priorityDisplay = document.getElementById('priorityClassDisplay');
    priorityDisplay.textContent = priorityVal ? priorityVal : '‚Äî';
}

// Change status function
function changeStatus(newStatus) {
    if (newStatus === '{{ todo.status.value }}') {
        return; // Already this status
    }
    
    // Create a form and submit it
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/api/todos/{{ todo.id }}/update';
    
    const statusInput = document.createElement('input');
    statusInput.type = 'hidden';
    statusInput.name = 'status';
    statusInput.value = newStatus;
    form.appendChild(statusInput);

    // If moving to a non-active status, explicitly clear queue.
    if (!isQueueRelevantStatus(newStatus)) {
        const queueInput = document.createElement('input');
        queueInput.type = 'hidden';
        queueInput.name = 'queue';
        queueInput.value = '0';
        form.appendChild(queueInput);
    }
    
    document.body.appendChild(form);
    form.submit();
}

// Load topics and tags for autocomplete
let allTags = [];
let allTopics = [];

// Fetch tags
fetch('/api/tags')
    .then(res => res.json())
    .then(tags => {
        allTags = tags.map(t => t.name);
        renderTagSuggestionsDetail();
    });

// Fetch topics
fetch('/api/topics')
    .then(res => res.json())
    .then(topics => {
        allTopics = topics;
        const datalist = document.getElementById('topicListDetail');
        topics.forEach(topic => {
            const option = document.createElement('option');
            option.value = topic;
            datalist.appendChild(option);
        });
    });

// Copy todo ID to clipboard
function copyTodoId(todoId) {
    const text = `#${todoId}`;
    navigator.clipboard.writeText(text).then(() => {
        const btn = document.getElementById(`copyBtn${todoId}`);
        if (btn) {
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
            btn.title = 'Copied!';
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.title = 'Copy todo ID to clipboard';
            }, 2000);
        }
    }).catch(err => {
        console.error('Failed to copy:', err);
    });
}

// Render tag suggestions as clickable chips
function renderTagSuggestionsDetail() {
    const container = document.getElementById('tagSuggestionsDetail');
    if (!container) return;
    
    container.innerHTML = '<div class="text-xs text-muted-foreground w-full">Click to add:</div>';
    
    // Show first 20 tags
    allTags.slice(0, 20).forEach(tagName => {
        const chip = document.createElement('calcite-chip');
        chip.setAttribute('scale', 's');
        chip.setAttribute('appearance', 'outline');
        chip.setAttribute('icon-start', 'tag');
        chip.setAttribute('interactive', '');
        chip.textContent = tagName;
        chip.addEventListener('click', () => {
            const input = document.getElementById('tagsInput');
            const current = input.value.trim();
            if (current) {
                input.value = current + ', ' + tagName;
            } else {
                input.value = tagName;
            }
        });
        container.appendChild(chip);
    });
}

// Wire Calcite segmented controls (status + task size) to server updates
document.addEventListener('DOMContentLoaded', function () {
    const root = document.getElementById('ttTodoDetailRoot');
    const todoId = Number(root && root.dataset ? root.dataset.todoId : NaN);

    const topPriority = document.getElementById('ttTopPrioritySelect');
    if (topPriority && Number.isFinite(todoId)) {
        topPriority.addEventListener('change', function () {
            updateTodoFieldDetail(todoId, 'priority_class', topPriority.value);
        });
    }

    const topTaskSizeSeg = document.getElementById('ttTopTaskSizeSeg');
    if (topTaskSizeSeg && Number.isFinite(todoId)) {
        const handler = function () {
            const val = (topTaskSizeSeg.value || '').toString();
            if (val) updateTodoFieldDetail(todoId, 'task_size', val);
        };
        topTaskSizeSeg.addEventListener('change', handler);
        topTaskSizeSeg.addEventListener('calciteSegmentedControlChange', handler);
    }

    const statusSeg = document.getElementById('ttDetailStatusSeg');
    if (statusSeg) {
        const handler = function (e) {
            const val = (e?.target?.value || statusSeg.value || '').toString();
            if (val) changeStatus(val);
        };
        statusSeg.addEventListener('change', handler);
        statusSeg.addEventListener('calciteSegmentedControlChange', handler);
    }

    // Ensure queue controls reflect current status on initial load.
    applyQueueRelevanceUI(getCurrentStatusValue());

    const taskSizeSeg = document.getElementById('ttDetailTaskSizeSeg');
    if (taskSizeSeg) {
        const handler = function (e) {
            const val = (e?.target?.value || taskSizeSeg.value || '').toString();
            if (val && Number.isFinite(todoId)) updateTodoFieldDetail(todoId, 'task_size', val);
        };
        taskSizeSeg.addEventListener('change', handler);
        taskSizeSeg.addEventListener('calciteSegmentedControlChange', handler);
    }

    const copyBtn = document.getElementById('copyBtn');
    if (copyBtn && Number.isFinite(todoId)) {
        copyBtn.addEventListener('click', function () {
            copyTodoId(todoId);
        });
    }
});
</script>

</div>

{% endblock %}

