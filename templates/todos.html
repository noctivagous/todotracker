{% extends "base.html" %}

{% block title %}Todos - TodoTracker{% endblock %}

{# ------------------------------------------------------------------------- #}
{# JsRender Templates - Replaces Jinja2 macros                              #}
{# ------------------------------------------------------------------------- #}
<script type="text/javascript" src="/static/js/todo-views.js"></script>

{# ------------------------------------------------------------------------- #}
{# Legacy Jinja2 Macro (deprecated - kept for fallback)                    #}
{# ------------------------------------------------------------------------- #}
{% macro render_todo(todo, index=0) %}
<calcite-card class="tt-todo-item todo-item {{ todo.status.value }}"
              data-todo-id="{{ todo.id }}"
              data-url="/todo/{{ todo.id }}"
              data-tt-expanded="0">

    <!-- Summary Row (always visible in all views) -->
    <div slot="title" class="flex items-start justify-between gap-2">
        <div class="flex-1 space-y-1.5 min-w-0">
            <!-- Header Section: Chevron (compact), Title, ID, Badges -->
            <div class="flex items-center flex-wrap gap-1.5">
                <calcite-button type="button"
                                class="tt-accordion-toggle tt-accordion-toggle-btn"
                                data-action="toggle-accordion"
                                appearance="transparent"
                                scale="s"
                                aria-label="Expand/collapse">
                    <calcite-icon icon="chevron-right" scale="s"></calcite-icon>
                </calcite-button>

                <span class="tt-todo-title-display text-lg font-semibold tt-title-display" data-role="titleDisplay">
                    {{ todo.title }}
                </span>
                <calcite-input type="text"
                               class="tt-title-input hidden"
                               data-role="titleInput"
                               value="{{ todo.title|e }}"
                               onclick="event.stopPropagation()">
                </calcite-input>

                <div class="flex items-center gap-0.5 text-xs text-color-3" onclick="event.stopPropagation()">
                    <span class="tt-todo-id-number">#{{ todo.id }}</span>
                    <calcite-button data-action="copy-id"
                                    appearance="transparent"
                                    scale="xs"
                                    title="Copy todo ID to clipboard"
                                    id="copyBtn{{ todo.id }}">
                        <calcite-icon icon="copy" scale="s"></calcite-icon>
                    </calcite-button>
                </div>

                <calcite-chip appearance="solid" scale="s" class="status-{{ todo.status.value }}">
                    {{ todo.status.value.replace('_', ' ') }}
                </calcite-chip>

                <calcite-chip appearance="outline" scale="s" class="category-{{ todo.category.value }}">
                    {{ todo.category.value }}
                </calcite-chip>

                {% if todo.queue and todo.queue > 0 %}
                <calcite-chip appearance="solid" color="blue" scale="s">‚èØÔ∏è Queue {{ todo.queue }}</calcite-chip>
                {% endif %}

                {% if todo.priority_class %}
                <calcite-chip appearance="solid" color="orange" scale="s">üî∫ Priority {{ todo.priority_class }}</calcite-chip>
                {% endif %}

                {% if todo.task_size %}
                <calcite-chip appearance="outline" scale="s">üìè Size {{ todo.task_size }}/5</calcite-chip>
                {% endif %}

                {% if todo.topic %}
                <calcite-chip appearance="outline" scale="s">üìÅ {{ todo.topic }}</calcite-chip>
                {% endif %}

                {% for tag in todo.tags %}
                <calcite-chip appearance="outline" scale="s">üè∑Ô∏è {{ tag.name }}</calcite-chip>
                {% endfor %}
            </div>
        </div>

        <!-- Actions (always visible); Edit only in Full view -->
        <div class="tt-no-nav flex flex-col items-end gap-1.5" onclick="event.stopPropagation()">
            <div class="flex space-x-1.5">
                <calcite-button href="/todo/{{ todo.id }}"
                                 appearance="outline"
                                 scale="s"
                                 onclick="event.stopPropagation()">
                    View
                </calcite-button>
                <calcite-button type="button"
                                 appearance="outline"
                                 scale="s"
                                 data-action="edit">
                    Edit
                </calcite-button>
                <calcite-button type="button"
                                 appearance="solid"
                                 scale="s"
                                 class="tt-action-save hidden"
                                 data-action="save">
                    Save
                </calcite-button>
                <calcite-button type="button"
                                 appearance="outline"
                                 scale="s"
                                 class="tt-action-cancel hidden"
                                 data-action="cancel">
                    Cancel
                </calcite-button>
                <form action="/api/todos/{{ todo.id }}/delete" method="POST" class="tt-todo-delete-form inline"
                      onsubmit="return confirm('Delete this todo and all subtasks?')"
                      onclick="event.stopPropagation()">
                    <calcite-button type="submit"
                                     appearance="solid"
                                     kind="danger"
                                     scale="s">
                        Delete
                    </calcite-button>
                </form>
            </div>
        </div>
    </div>

    <!-- Details (Compact: accordion; Medium/Full: always visible) -->
    <div slot="content" class="tt-accordion-content tt-todo-details-content space-y-2">
        <div class="tt-todo-details-grid grid grid-cols-1 lg:grid-cols-[1fr_auto] gap-2">
            <div class="tt-todo-details-left space-y-2 min-w-0">
                <!-- Description -->
                <calcite-panel data-action="toggle-accordion">
                    <div slot="header">Description</div>
                    <div class="tt-desc-display tt-todo-description-display text-sm text-color-2 markdown-render"
                         data-role="descDisplay"
                         data-placeholder="No description">{{ todo.description or '' }}</div>
                    <calcite-text-area class="tt-desc-input tt-todo-description-input hidden"
                                       data-role="descInput"
                                       rows="4"
                                       onclick="event.stopPropagation()">{{ todo.description or '' }}</calcite-text-area>
                </calcite-panel>

                <!-- Progress Sections (hidden in Medium view) -->
                {% if todo.work_completed or todo.work_remaining or todo.implementation_issues or todo.progress_summary or todo.remaining_work %}
                <calcite-panel>
                    <div slot="header">Progress</div>
                    <div class="space-y-2">
                        {% if todo.work_completed %}
                            <div class="tt-todo-progress-completed">
                                <strong>Work completed:</strong>
                                <div class="tt-todo-progress-completed-content text-color-2 markdown-render">{{ todo.work_completed }}</div>
                            </div>
                        {% endif %}
                        {% if todo.work_remaining %}
                            <div class="tt-todo-progress-remaining">
                                <strong>Work remaining:</strong>
                                <div class="tt-todo-progress-remaining-content text-color-2 markdown-render">{{ todo.work_remaining }}</div>
                            </div>
                        {% endif %}
                        {% if todo.implementation_issues %}
                            <div class="tt-todo-progress-issues">
                                <strong>Issues:</strong>
                                <div class="tt-todo-progress-issues-content text-color-2 markdown-render">{{ todo.implementation_issues }}</div>
                            </div>
                        {% endif %}
                        {% if todo.progress_summary %}
                            <div class="tt-todo-progress-summary">
                                <strong>Progress (legacy):</strong>
                                <div class="tt-todo-progress-summary-content text-color-2 markdown-render">{{ todo.progress_summary }}</div>
                            </div>
                        {% endif %}
                        {% if todo.remaining_work %}
                            <div class="tt-todo-progress-remaining-legacy">
                                <strong>Remaining (legacy):</strong>
                                <div class="tt-todo-progress-remaining-legacy-content text-color-2 markdown-render">{{ todo.remaining_work }}</div>
                            </div>
                        {% endif %}
                    </div>
                </calcite-panel>
                {% endif %}

                <!-- Metadata: Timestamps -->
                <calcite-notice scale="s" open>
                    <div slot="message">
                        Created: {{ todo.created_at.strftime('%b %d %Y %H:%M') }}
                        {% if todo.updated_at != todo.created_at %}
                            | Updated: {{ todo.updated_at.strftime('%b %d %Y %H:%M') }}
                        {% endif %}
                    </div>
                </calcite-notice>
            </div>

            <!-- Controls (Queue / Priority / Size). Compact: only when expanded -->
            <div class="tt-controls-block tt-todo-controls-box space-y-2 tt-no-nav" onclick="event.stopPropagation()">
                <!-- Queue Controls -->
                <calcite-panel>
                    <div slot="header">Queue Controls</div>
                    <div class="space-y-2">
                        <form action="{% if todo.queue and todo.queue > 0 %}/api/todos/{{ todo.id }}/queue/remove{% else %}/api/todos/{{ todo.id }}/queue/add{% endif %}" method="POST" class="tt-todo-queue-toggle-form">
                            <calcite-label>
                                <calcite-switch {% if todo.queue and todo.queue > 0 %}checked{% endif %}
                                                onchange="this.closest('form').submit()"></calcite-switch>
                                Queued
                            </calcite-label>
                        </form>
                        {% if todo.queue and todo.queue > 0 %}
                            <div class="flex items-center gap-2">
                                <span class="font-semibold text-color-brand">#{{ todo.queue }}</span>
                                <form action="/api/todos/{{ todo.id }}/queue/up" method="POST" class="tt-todo-queue-up-form">
                                    <button type="submit"
                                            {% if todo.queue <= 1 %}disabled{% endif %}
                                            class="tt-todo-queue-up-btn px-2 py-1 rounded bg-gray-200 hover:bg-gray-300 disabled:opacity-40 disabled:hover:bg-gray-200"
                                            title="Move up in queue">
                                        ‚Üë
                                    </button>
                                </form>
                                <form action="/api/todos/{{ todo.id }}/queue/down" method="POST" class="tt-todo-queue-down-form inline">
                                    <button type="submit"
                                            {% if max_queue and todo.queue >= max_queue %}disabled{% endif %}
                                            class="tt-todo-queue-down-btn px-2 py-1 rounded bg-gray-200 hover:bg-gray-300 disabled:opacity-40 disabled:hover:bg-gray-200"
                                            title="Move down in queue">
                                        ‚Üì
                                    </button>
                                </form>
                            {% endif %}
                        </div>
                        <div class="space-y-2">
                            <!-- Priority Dropdown -->
                            <calcite-label>
                                Priority Class
                                <calcite-select name="priority_class"
                                                data-todo-id="{{ todo.id }}"
                                                data-field="priority_class"
                                                scale="s"
                                                onclick="event.stopPropagation()">
                                    <calcite-option value="" {% if not todo.priority_class %}selected{% endif %}></calcite-option>
                                    {% for p in ['A','B','C','D','E'] %}
                                        <calcite-option value="{{ p }}" {% if todo.priority_class == p %}selected{% endif %}>{{ p }}</calcite-option>
                                    {% endfor %}
                                </calcite-select>
                            </calcite-label>

                            <!-- Task Size Segmented Control -->
                            <calcite-label>
                                Task Size (1-5)
                                <calcite-segmented-control onclick="event.stopPropagation()">
                                    {% for s in range(1, 6) %}
                                        <calcite-segmented-control-item value="{{ s }}"
                                                                       {% if todo.task_size == s %}checked{% endif %}
                                                                       data-action="set-task-size"
                                                                       data-value="{{ s }}">
                                            {{ s }}
                                        </calcite-segmented-control-item>
                                    {% endfor %}
                                </calcite-segmented-control>
                            </calcite-label>
                        </div>
                    </div>
                </calcite-panel>
            </div>
        </div>

        <!-- Render children recursively -->
        {% if todo.children %}
            <div class="tt-children-block tt-todo-children-container ml-6 mt-3 space-y-2">
                {% for child in todo.children %}
                    {{ render_todo(child, loop.index0) }}
                {% endfor %}
            </div>
        {% endif %}
    </div>
</calcite-card>
{% endmacro %}

{% block content %}
<div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold">
        {% if is_search_page %}
            Search Results{% if search_query %}: "{{ search_query }}"{% endif %}
        {% else %}
            Todo List
        {% endif %}
    </h1>
    <div class="flex items-center gap-3">
        <!-- Search Box -->
        <calcite-input type="text"
                       id="searchInput"
                       placeholder="Search todos..."
                       value="{{ search_query or '' }}"
                       onkeydown="if(event.key === 'Enter') { handleSearch(event); }"
                       scale="m">
        </calcite-input>

        <!-- Sort Controls (preserve filters) -->
        <form method="GET" action="{% if is_search_page %}/search{% else %}/{% endif %}" class="flex items-center gap-2">
            {% if is_search_page and search_query %}
                <input type="hidden" name="q" value="{{ search_query }}">
            {% endif %}
            <input type="hidden" name="status" value="{{ current_status_filter or 'pending' }}">
            {% if queued_filter %}
                <input type="hidden" name="queued" value="true">
            {% endif %}
            <calcite-label>Sort by
                <calcite-select name="sort_by" onchange="this.form.submit()" scale="s">
                    <calcite-option value="activity" {% if current_sort_by == 'activity' %}selected{% endif %}>Activity</calcite-option>
                    <calcite-option value="updated_at" {% if current_sort_by == 'updated_at' %}selected{% endif %}>Updated</calcite-option>
                    <calcite-option value="created_at" {% if current_sort_by == 'created_at' %}selected{% endif %}>Created</calcite-option>
                    <calcite-option value="title" {% if current_sort_by == 'title' %}selected{% endif %}>Title</calcite-option>
                    <calcite-option value="status" {% if current_sort_by == 'status' %}selected{% endif %}>Status</calcite-option>
                    <calcite-option value="category" {% if current_sort_by == 'category' %}selected{% endif %}>Category</calcite-option>
                    <calcite-option value="queue" {% if current_sort_by == 'queue' %}selected{% endif %}>Queue</calcite-option>
                    <calcite-option value="priority_class" {% if current_sort_by == 'priority_class' %}selected{% endif %}>Priority</calcite-option>
                    <calcite-option value="task_size" {% if current_sort_by == 'task_size' %}selected{% endif %}>Task Size</calcite-option>
                </calcite-select>
            </calcite-label>
            <calcite-select name="sort_dir" onchange="this.form.submit()" scale="s">
                <calcite-option value="desc" {% if current_sort_dir == 'desc' %}selected{% endif %}>Desc</calcite-option>
                <calcite-option value="asc" {% if current_sort_dir == 'asc' %}selected{% endif %}>Asc</calcite-option>
            </calcite-select>
        </form>

        <!-- Export Dropdown -->
        <calcite-dropdown>
            <calcite-button slot="trigger" appearance="outline" scale="m">
                <calcite-icon icon="download" scale="s"></calcite-icon>
                Export
            </calcite-button>
            <calcite-dropdown-group>
                <calcite-dropdown-item href="/api/export/json">
                    üìÑ Export as JSON
                </calcite-dropdown-item>
                <calcite-dropdown-item href="/api/export/csv">
                    üìä Export as CSV
                </calcite-dropdown-item>
                <calcite-dropdown-item href="/api/export/markdown">
                    üìù Export as Markdown
                </calcite-dropdown-item>
            </calcite-dropdown-group>
        </calcite-dropdown>
        
        <!-- New Todo Button -->
        <calcite-button onclick="document.getElementById('createModal').open = true"
                         appearance="solid">
            + New Todo
        </calcite-button>
    </div>
</div>

<div class="flex flex-wrap gap-2 mb-4">
    {% if is_search_page %}
        <calcite-button href="/?status={{ current_status_filter or 'pending' }}&sort_by={{ current_sort_by }}&sort_dir={{ current_sort_dir }}"
                         appearance="outline"
                         scale="s">
            ‚Üê Back to All Todos
        </calcite-button>
    {% else %}
        <calcite-button href="/?status={{ current_status_filter or 'pending' }}&sort_by={{ current_sort_by }}&sort_dir={{ current_sort_dir }}"
                         {% if not queued_filter %}appearance="solid"{% else %}appearance="outline"{% endif %}
                         scale="s">
            All (current status filter)
        </calcite-button>
        <calcite-button href="/?status={{ current_status_filter or 'pending' }}&queued=true&sort_by={{ current_sort_by }}&sort_dir={{ current_sort_dir }}"
                         {% if queued_filter %}appearance="solid"{% else %}appearance="outline"{% endif %}
                         scale="s">
            In queue ({{ stats.queued }})
        </calcite-button>
    {% endif %}
</div>

<!-- Statistics -->
<div class="tt-stats-container grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
    <calcite-card href="/?status=all&sort_by={{ current_sort_by }}&sort_dir={{ current_sort_dir }}" class="cursor-pointer {% if current_status_filter == 'all' %}tt-ring{% endif %}">
        <div class="tt-stat-label text-sm text-muted-foreground">Total</div>
        <div class="tt-stat-value text-2xl font-bold">{{ stats.total }}</div>
    </calcite-card>
    <calcite-card class="{% if not current_status_filter or current_status_filter == 'pending' %}tt-ring{% endif %}">
        <div class="tt-stat-pending-inner flex items-center justify-between">
            <calcite-link href="/?status=pending&sort_by={{ current_sort_by }}&sort_dir={{ current_sort_dir }}" class="flex-1 cursor-pointer">
                <div class="tt-stat-label text-sm text-muted-foreground">Pending</div>
                <div class="tt-stat-value text-2xl font-bold">{{ stats.pending }}</div>
            </calcite-link>
            <calcite-button href="/?status={{ current_status_filter or 'pending' }}&queued=true&sort_by={{ current_sort_by }}&sort_dir={{ current_sort_dir }}"
                             {% if queued_filter %}appearance="solid"{% else %}appearance="outline"{% endif %}
                             scale="s"
                             onclick="event.stopPropagation()">
                {{ stats.queued }}
            </calcite-button>
        </div>
    </calcite-card>
    <calcite-card href="/?status=in_progress&sort_by={{ current_sort_by }}&sort_dir={{ current_sort_dir }}" class="cursor-pointer {% if current_status_filter == 'in_progress' %}tt-ring{% endif %}">
        <div class="tt-stat-label text-sm text-muted-foreground">In Progress</div>
        <div class="tt-stat-value text-2xl font-bold">{{ stats.in_progress }}</div>
    </calcite-card>
    <calcite-card href="/?status=completed&sort_by={{ current_sort_by }}&sort_dir={{ current_sort_dir }}" class="cursor-pointer {% if current_status_filter == 'completed' %}tt-ring{% endif %}">
        <div class="tt-stat-label text-sm text-muted-foreground">Completed</div>
        <div class="tt-stat-value text-2xl font-bold">{{ stats.completed }}</div>
    </calcite-card>
</div>

<!-- View Mode Toggle (above listing) -->
<div class="tt-view-mode-toggle-container flex items-center gap-2 mb-4">
    <div class="tt-view-mode-toggle-label text-sm text-muted-foreground font-medium">View</div>
    <calcite-segmented-control id="ttViewModeToggle" title="View mode">
        <calcite-segmented-control-item value="compact" data-view="compact">Compact</calcite-segmented-control-item>
        <calcite-segmented-control-item value="medium" data-view="medium">Medium</calcite-segmented-control-item>
        <calcite-segmented-control-item value="full" data-view="full">Full</calcite-segmented-control-item>
    </calcite-segmented-control>
    <calcite-segmented-control class="hidden" id="ttDescColumnsToggle" title="Description columns (Full view)">
        <calcite-segmented-control-item value="1" data-cols="1">1</calcite-segmented-control-item>
        <calcite-segmented-control-item value="2" data-cols="2">2</calcite-segmented-control-item>
        <calcite-segmented-control-item value="3" data-cols="3">3</calcite-segmented-control-item>
    </calcite-segmented-control>
</div>

<!-- Todo Tree -->
<calcite-card class="tt-todo-list-card">
    <div class="tt-todo-list-content" id="todoList">
        <!-- Todos will be rendered here by JsRender -->
        <div class="text-center py-12 text-muted-foreground">
            <p class="text-lg">Loading todos...</p>
        </div>
    </div>
</calcite-card>

<script>
// Initialize todo rendering with JsRender
(function() {
    // Wait for dependencies
    function waitForDeps(callback) {
        if (typeof $ !== 'undefined' && typeof $.templates !== 'undefined' && typeof window.getCurrentViewMode === 'function') {
            callback();
        } else {
            setTimeout(() => waitForDeps(callback), 100);
        }
    }

    // Convert server-side todo data to format expected by JsRender
    function prepareTodoData(todo) {
        const prepared = {
            id: todo.id,
            title: todo.title || '',
            description: todo.description || '',
            status: typeof todo.status === 'object' ? todo.status.value : todo.status,
            category: typeof todo.category === 'object' ? todo.category.value : todo.category,
            queue: todo.queue || 0,
            priority_class: todo.priority_class || null,
            task_size: todo.task_size || null,
            topic: todo.topic || null,
            tags: (todo.tags || []).map(t => typeof t === 'object' ? { name: t.name } : { name: t }),
            work_completed: todo.work_completed || null,
            work_remaining: todo.work_remaining || null,
            implementation_issues: todo.implementation_issues || null,
            created_at: typeof todo.created_at === 'string' ? todo.created_at : (todo.created_at ? todo.created_at.toISOString() : ''),
            updated_at: typeof todo.updated_at === 'string' ? todo.updated_at : (todo.updated_at ? todo.updated_at.toISOString() : ''),
            expanded: false,
            editingEnabled: false
        };

        // Check localStorage for expanded state (compact view)
        if (window.getCurrentViewMode && window.getCurrentViewMode() === 'compact') {
            try {
                const expanded = localStorage.getItem(`tt-accordion-${todo.id}`) === '1';
                prepared.expanded = expanded;
            } catch (e) {}
        }

        // Recursively prepare children
        if (todo.children && todo.children.length > 0) {
            prepared.children = todo.children.map(child => prepareTodoData(child));
        }

        return prepared;
    }

    // Render todos using JsRender
    window.rerenderTodos = async function() {
        const container = document.getElementById('todoList');
        if (!container) return;

        try {
            // Fetch todos from API
            const response = await fetch('/api/todos');
            if (!response.ok) throw new Error('Failed to fetch todos');
            const todos = await response.json();

            if (!todos || todos.length === 0) {
                container.innerHTML = '<div class="text-center py-12 text-muted-foreground"><p class="text-lg">No todos yet.</p><p class="text-sm mt-2">Create your first todo to get started!</p></div>';
                return;
            }

            // Prepare todos data
            const preparedTodos = todos.map(todo => prepareTodoData(todo));

            // Render using JsRender
            waitForDeps(function() {
                if (typeof $.templates === 'undefined' || !$.templates.todoItem) {
                    console.error('JsRender templates not loaded');
                    return;
                }

                const viewMode = window.getCurrentViewMode ? window.getCurrentViewMode() : 'full';
                let html = '';

                if (viewMode === 'compact') {
                    // For compact view, wrap all root todos in a single accordion
                    html = '<calcite-accordion selection-mode="multiple" class="tt-todo-accordion">';
                    preparedTodos.forEach(todo => {
                        html += renderTodoItem(todo, viewMode, true); // true = isRoot
                    });
                    html += '</calcite-accordion>';
                } else {
                    // For medium and full views, render each todo as a card
                    preparedTodos.forEach(todo => {
                        html += renderTodoItem(todo, viewMode, true);
                    });
                }

                container.innerHTML = html;

                // Initialize Calcite components
                if (window.initializeAccordionHandlers) {
                    window.initializeAccordionHandlers();
                }
                if (window.initializeInlineEditing) {
                    window.initializeInlineEditing();
                }

                // Render markdown
                if (typeof renderMarkdown === 'function') {
                    document.querySelectorAll('.markdown-render').forEach(el => {
                        renderMarkdown(el);
                    });
                }

                // Re-attach event handlers
                attachEventHandlers();
            });
        } catch (error) {
            console.error('Error rendering todos:', error);
            container.innerHTML = '<div class="text-center py-12 text-color-danger"><p class="text-lg">Failed to load todos. Please refresh the page.</p></div>';
        }
    };

    // Render a single todo item
    function renderTodoItem(todo, viewMode, isRoot = false) {
        if (typeof $.templates === 'undefined' || !$.templates.todoItem) {
            return '';
        }

        const template = $.templates.todoItem;
        const data = {
            ...todo,
            viewMode: viewMode
        };

        let html = template.render(data);

        // Recursively render children
        if (todo.children && todo.children.length > 0) {
            let childrenHtml = '';
            if (viewMode === 'compact') {
                // For compact view, children are also accordion items (nested)
                childrenHtml = todo.children.map(child => renderTodoItem(child, viewMode, false)).join('');
            } else {
                // For other views, children are cards
                childrenHtml = todo.children.map(child => renderTodoItem(child, viewMode, false)).join('');
            }
            
            // Insert children before closing tag
            if (viewMode === 'compact') {
                html = html.replace('</calcite-accordion-item>', childrenHtml + '</calcite-accordion-item>');
            } else {
                html = html.replace('</calcite-card>', childrenHtml + '</calcite-card>');
            }
        }

        return html;
    }

    // Attach event handlers for interactive elements
    function attachEventHandlers() {
        const list = document.getElementById('todoList');
        if (!list) return;

        // Priority dropdown change
        list.addEventListener('change', function(e) {
            const el = e.target.closest('[data-field="priority_class"]');
            if (!el) return;
            const item = el.closest('[data-todo-id]');
            if (!item) return;
            const todoId = item.getAttribute('data-todo-id');
            const value = el.value || '';
            updateTodoField(todoId, 'priority_class', value);
        });

        // Task size segmented control
        list.addEventListener('click', function(e) {
            const actionEl = e.target.closest('[data-action="set-task-size"]');
            if (!actionEl) return;
            const item = actionEl.closest('[data-todo-id]');
            if (!item) return;
            const todoId = item.getAttribute('data-todo-id');
            const val = actionEl.getAttribute('data-value') || '';
            updateTodoField(todoId, 'task_size', val);
        });
    }

    // Update todo field via AJAX
    async function updateTodoField(todoId, fieldName, fieldValue) {
        const formData = new FormData();
        formData.append(fieldName, fieldValue);
        
        try {
            const response = await fetch(`/api/todos/${todoId}/update`, {
                method: 'POST',
                body: formData,
                redirect: 'manual'
            });
            
            if (response.ok || response.status === 303 || response.status === 302) {
                // Re-render to show updated values
                window.rerenderTodos();
            } else {
                console.error('Failed to update todo:', response.statusText);
                window.rerenderTodos();
            }
        } catch (error) {
            console.error('Error updating todo:', error);
            window.rerenderTodos();
        }
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
        waitForDeps(function() {
            window.rerenderTodos();
        });
    });
})();
</script>

<!-- Create Dialog -->
<calcite-dialog id="createModal" label="Create New Todo">
    <form id="createModalForm" action="/api/todos/form" method="POST" slot="content" class="space-y-4">
        <calcite-label>
            Title*
            <calcite-input type="text" name="title" required></calcite-input>
        </calcite-label>
        
        <calcite-label>
            Description
            <calcite-text-area name="description" rows="3"></calcite-text-area>
        </calcite-label>
        
        <calcite-label>
            Category
            <calcite-select name="category">
                {% for cat in categories %}
                    <calcite-option value="{{ cat }}">{{ cat }}</calcite-option>
                {% endfor %}
            </calcite-select>
        </calcite-label>
        
        <calcite-label>
            Topic
            <span class="text-color-3 text-xs">(optional, e.g., "window layout")</span>
            <calcite-input type="text" name="topic" id="topicInput" list="topicList"></calcite-input>
            <datalist id="topicList" class="tt-create-form-topic-datalist"></datalist>
        </calcite-label>
        
        <calcite-label>
            Tags
            <span class="text-color-3 text-xs">(optional, comma-separated)</span>
            <calcite-input type="text" name="tags" id="tagsInput"
                           placeholder="e.g., ui, frontend, urgent"></calcite-input>
            <div id="tagSuggestions" class="mt-2 flex flex-wrap gap-2"></div>
        </calcite-label>
    </form>
    
    <calcite-button slot="primary" type="submit" form="createModalForm" appearance="solid">
        Create
    </calcite-button>
    <calcite-button slot="secondary" onclick="document.getElementById('createModal').open = false" appearance="outline">
        Cancel
    </calcite-button>
</calcite-dialog>

<script>
// -----------------------------
// View modes + accordion + inline edit
// -----------------------------
(function () {
    const VIEW_KEY = 'tt-view-mode';
    const DESC_COLS_KEY = 'tt-desc-columns';
    const DEFAULT_VIEW = 'full';
    const DEFAULT_DESC_COLS = 2;

    function getViewMode() {
        try { return localStorage.getItem(VIEW_KEY) || DEFAULT_VIEW; } catch (e) { return DEFAULT_VIEW; }
    }
    function setViewMode(mode) {
        try { localStorage.setItem(VIEW_KEY, mode); } catch (e) {}
        document.documentElement.setAttribute('data-tt-view', mode);

        // If leaving Full view while editing, cancel edit UI.
        if (mode !== 'full' && typeof editingTodoId === 'number' && editingTodoId !== null) {
            try { window.cancelInlineEdit(editingTodoId); } catch (e) {}
        }

        // Update segmented control selected value
        const toggle = document.getElementById('ttViewModeToggle');
        if (toggle) {
            toggle.value = mode;
            // Also update the selectedItem property if available
            const items = toggle.querySelectorAll('calcite-segmented-control-item');
            items.forEach(item => {
                if (item.value === mode || item.getAttribute('data-view') === mode) {
                    item.setAttribute('selected', '');
                } else {
                    item.removeAttribute('selected');
                }
            });
        }

        // Only show description columns control in Full view
        const colsToggle = document.getElementById('ttDescColumnsToggle');
        if (colsToggle) colsToggle.classList.toggle('hidden', mode !== 'full');

        // When leaving compact view, remove inline maxHeight/opacity constraints so layout is natural
        if (mode !== 'compact') {
            document.querySelectorAll('.tt-accordion-content').forEach(el => {
                el.style.maxHeight = '';
                el.style.opacity = '';
            });
        } else {
            // In compact, first hide ALL accordion content immediately
            document.querySelectorAll('.tt-accordion-content').forEach(content => {
                content.style.maxHeight = '0px';
                content.style.opacity = '0';
            });
            // Then apply persisted expanded state (or default to collapsed)
            document.querySelectorAll('.todo-item[data-todo-id]').forEach(item => {
                const id = item.getAttribute('data-todo-id');
                const key = `tt-accordion-${id}`;
                let expanded = false;
                try { expanded = localStorage.getItem(key) === '1'; } catch (e) {}
                // Ensure data attribute is set
                item.setAttribute('data-tt-expanded', expanded ? '1' : '0');
                // Apply styles explicitly for expanded items
                if (expanded) {
                    setExpandedByElement(item, true, false);
                }
            });
        }
    }

    function getDescCols() {
        try {
            const v = parseInt(localStorage.getItem(DESC_COLS_KEY) || String(DEFAULT_DESC_COLS), 10);
            if (Number.isFinite(v) && v >= 1 && v <= 3) return v;
        } catch (e) {}
        return DEFAULT_DESC_COLS;
    }
    function setDescCols(cols) {
        try { localStorage.setItem(DESC_COLS_KEY, String(cols)); } catch (e) {}
        document.documentElement.style.setProperty('--tt-desc-columns', String(cols));
        const colsToggle = document.getElementById('ttDescColumnsToggle');
        if (colsToggle) {
            colsToggle.value = String(cols);
            // Also update the selectedItem property if available
            const items = colsToggle.querySelectorAll('calcite-segmented-control-item');
            items.forEach(item => {
                if (item.value === String(cols) || item.getAttribute('data-cols') === String(cols)) {
                    item.setAttribute('selected', '');
                } else {
                    item.removeAttribute('selected');
                }
            });
        }
    }

    function isCompact() {
        return document.documentElement.getAttribute('data-tt-view') === 'compact';
    }

    function refreshAncestorHeights(startEl) {
        // If nested accordions exist, expanding a child changes the parent's scrollHeight.
        // Recompute maxHeight for any expanded ancestors so content isn't clipped.
        let el = startEl ? startEl.parentElement : null;
        while (el) {
            const parentTodo = el.closest && el.closest('.todo-item[data-todo-id]');
            if (!parentTodo) break;
            const isExpanded = parentTodo.getAttribute('data-tt-expanded') === '1';
            const content = parentTodo.querySelector('.tt-accordion-content');
            if (isCompact() && isExpanded && content) {
                // Recalculate height for nested accordions
                const height = content.scrollHeight;
                content.style.maxHeight = height + 'px';
                content.style.opacity = '1';
            }
            el = parentTodo.parentElement;
        }
    }

    function setExpandedByElement(itemEl, expanded, persist = true) {
        if (!itemEl) return;
        const id = itemEl.getAttribute('data-todo-id');
        itemEl.setAttribute('data-tt-expanded', expanded ? '1' : '0');

        if (persist && id) {
            try { localStorage.setItem(`tt-accordion-${id}`, expanded ? '1' : '0'); } catch (e) {}
        }

        const content = itemEl.querySelector('.tt-accordion-content');
        if (content && isCompact()) {
            if (expanded) {
                // First collapse it to measure
                content.style.maxHeight = '0px';
                content.style.opacity = '0';
                // Force reflow to ensure collapse happens
                void content.offsetHeight;
                // Now measure and expand
                const height = content.scrollHeight;
                content.style.maxHeight = height + 'px';
                content.style.opacity = '1';
            } else {
                // Collapse: set inline styles to override any previous expanded state
                content.style.maxHeight = '0px';
                content.style.opacity = '0';
            }
        } else if (content && !isCompact()) {
            // Not in compact mode - clear inline styles so CSS can handle it
            content.style.maxHeight = '';
            content.style.opacity = '';
        }

        refreshAncestorHeights(itemEl);
    }

    window.toggleTodoAccordion = function (todoId) {
        const item = document.querySelector(`.todo-item[data-todo-id="${todoId}"]`);
        if (!item) return;
        const expanded = item.getAttribute('data-tt-expanded') === '1';
        setExpandedByElement(item, !expanded, true);
    };

    // Inline edit (Full view only; title + description)
    let editingTodoId = null;

    function getTodoEl(todoId) {
        return document.querySelector(`.todo-item[data-todo-id="${todoId}"]`);
    }

    function setEditMode(todoId, enabled) {
        const item = getTodoEl(todoId);
        if (!item) return;
        item.setAttribute('data-tt-editing', enabled ? '1' : '0');

        const titleDisplay = item.querySelector('[data-role="titleDisplay"]');
        const titleInput = item.querySelector('[data-role="titleInput"]');
        const descDisplay = item.querySelector('[data-role="descDisplay"]');
        const descInput = item.querySelector('[data-role="descInput"]');

        if (enabled) {
            if (titleInput && titleDisplay) titleInput.value = (titleDisplay.textContent || '').trim();
            // Don't overwrite the textarea with rendered markdown textContent; keep the raw value.
        }

        if (titleDisplay) titleDisplay.classList.toggle('hidden', enabled);
        if (titleInput) titleInput.classList.toggle('hidden', !enabled);
        if (descDisplay) descDisplay.classList.toggle('hidden', enabled);
        if (descInput) descInput.classList.toggle('hidden', !enabled);

        const editBtn = item.querySelector('.tt-action-edit');
        const saveBtn = item.querySelector('.tt-action-save');
        const cancelBtn = item.querySelector('.tt-action-cancel');
        if (editBtn) editBtn.classList.toggle('hidden', enabled);
        if (saveBtn) saveBtn.classList.toggle('hidden', !enabled);
        if (cancelBtn) cancelBtn.classList.toggle('hidden', !enabled);

        if (enabled && titleInput) titleInput.focus();
    }

    window.enterInlineEdit = function (todoId) {
        // Only enable inline edit in Full view
        if (document.documentElement.getAttribute('data-tt-view') !== 'full') return;
        if (editingTodoId && editingTodoId !== todoId) {
            window.cancelInlineEdit(editingTodoId);
        }
        editingTodoId = todoId;
        setEditMode(todoId, true);
    };

    window.cancelInlineEdit = function (todoId) {
        setEditMode(todoId, false);
        if (editingTodoId === todoId) editingTodoId = null;
    };

    window.saveInlineEdit = async function (todoId) {
        const item = getTodoEl(todoId);
        if (!item) return;

        const titleInput = item.querySelector('[data-role="titleInput"]');
        const descInput = item.querySelector('[data-role="descInput"]');
        const newTitle = titleInput ? titleInput.value.trim() : '';
        const newDesc = descInput ? descInput.value : '';

        if (!newTitle) {
            alert('Title is required.');
            if (titleInput) titleInput.focus();
            return;
        }

        const formData = new FormData();
        formData.append('title', newTitle);
        formData.append('description', newDesc);

        try {
            const resp = await fetch(`/api/todos/${todoId}/update`, {
                method: 'POST',
                body: formData,
                redirect: 'manual'
            });

            const ok = resp.ok || resp.status === 303 || resp.status === 302;
            if (!ok) throw new Error(`Update failed (${resp.status})`);

            const titleDisplay = item.querySelector('[data-role="titleDisplay"]');
            const descDisplay = item.querySelector('[data-role="descDisplay"]');

            if (titleDisplay) titleDisplay.textContent = newTitle;
            if (descDisplay) {
                descDisplay.classList.remove('markdown-content');
                descDisplay.textContent = newDesc || '';
                if (typeof renderMarkdown === 'function') {
                    renderMarkdown(descDisplay);
                }
            }

            // Keep raw textarea in sync for future edits.
            if (descInput) descInput.value = newDesc || '';

            setEditMode(todoId, false);
            if (editingTodoId === todoId) editingTodoId = null;
        } catch (e) {
            console.error(e);
            alert('Failed to save changes. Please try again.');
        }
    };

    function getEventPath(event) {
        if (!event) return [];
        if (typeof event.composedPath === 'function') {
            return event.composedPath();
        }
        const path = [];
        let node = event.target;
        while (node) {
            path.push(node);
            node = node.parentNode;
        }
        return path;
    }

    function findElementInPath(path, selector) {
        for (const node of path) {
            if (node instanceof Element && node.matches(selector)) {
                return node;
            }
        }
        return null;
    }

    function isInteractiveTarget(path) {
        const selectors = [
            'a',
            'button',
            'input',
            'select',
            'textarea',
            'label',
            'form',
            '.tt-no-nav',
            'calcite-button',
            'calcite-link',
            'calcite-select',
            'calcite-switch',
            'calcite-segmented-control',
            'calcite-segmented-control-item',
            'calcite-dropdown',
            'calcite-dropdown-item',
            '[data-action]'
        ];
        return path.some(node => node instanceof Element && selectors.some(sel => node.matches(sel)));
    }

    function handleTodoClick(e) {
        const list = document.getElementById('todoList');
        if (!list) return;

        const path = getEventPath(e);
        const item = findElementInPath(path, '.todo-item[data-todo-id]');
        if (!item || !list.contains(item)) return;

        if (isCompact()) {
            const toggle = findElementInPath(path, '.tt-accordion-toggle-btn, [data-action="toggle-accordion"]');
            if (toggle) {
                const expanded = item.getAttribute('data-tt-expanded') === '1';
                setExpandedByElement(item, !expanded, true);
                return;
            }
        }

        if (isInteractiveTarget(path)) return;

        const url = item.getAttribute('data-url');
        if (url) window.location.href = url;
    }

    // Wait for Calcite components to be defined
    function waitForCalcite(callback) {
        if (customElements.get('calcite-segmented-control')) {
            callback();
        } else {
            customElements.whenDefined('calcite-segmented-control').then(callback);
        }
    }

    // Init
    document.addEventListener('DOMContentLoaded', function () {
        waitForCalcite(function() {
            // Wire view mode toggle UI
            const toggle = document.getElementById('ttViewModeToggle');
            if (toggle) {
                // Handle change event (standard DOM event)
                toggle.addEventListener('change', function (e) {
                    const mode = e.target.value;
                    if (mode && window.setViewMode) {
                        window.setViewMode(mode);
                        if (window.rerenderTodos) {
                            window.rerenderTodos();
                        }
                    }
                });
                // Handle Calcite-specific event as fallback
                toggle.addEventListener('calciteSegmentedControlChange', function (e) {
                    const mode = e.target.selectedItem?.value || e.target.value || e.detail?.value;
                    if (mode && window.setViewMode) {
                        window.setViewMode(mode);
                        if (window.rerenderTodos) {
                            window.rerenderTodos();
                        }
                    }
                });
                // Also handle direct clicks on items as fallback
                toggle.querySelectorAll('calcite-segmented-control-item[data-view]').forEach(item => {
                    item.addEventListener('click', function (e) {
                        const mode = item.getAttribute('data-view') || item.value;
                        if (mode && window.setViewMode) {
                            e.preventDefault();
                            e.stopPropagation();
                            window.setViewMode(mode);
                            toggle.value = mode;
                            if (window.rerenderTodos) {
                                window.rerenderTodos();
                            }
                        }
                    });
                });
            }

            const colsToggle = document.getElementById('ttDescColumnsToggle');
            if (colsToggle) {
                // Handle change event (standard DOM event)
                colsToggle.addEventListener('change', function (e) {
                    const cols = e.target.value;
                    if (cols) {
                        const colsNum = parseInt(cols, 10);
                        if (Number.isFinite(colsNum)) setDescCols(colsNum);
                    }
                });
                // Handle Calcite-specific event as fallback
                colsToggle.addEventListener('calciteSegmentedControlChange', function (e) {
                    const cols = e.target.selectedItem?.value || e.target.value || e.detail?.value;
                    if (cols) {
                        const colsNum = parseInt(cols, 10);
                        if (Number.isFinite(colsNum)) setDescCols(colsNum);
                    }
                });
                // Also handle direct clicks on items as fallback
                colsToggle.querySelectorAll('calcite-segmented-control-item[data-cols]').forEach(item => {
                    item.addEventListener('click', function (e) {
                        const cols = item.getAttribute('data-cols') || item.value;
                        if (cols) {
                            e.preventDefault();
                            e.stopPropagation();
                            const colsNum = parseInt(cols, 10);
                            if (Number.isFinite(colsNum)) {
                                setDescCols(colsNum);
                                colsToggle.value = cols;
                            }
                        }
                    });
                });
            }

            // Apply persisted settings
            const initialView = getViewMode();
            const initialCols = getDescCols();
            setDescCols(initialCols);
            setViewMode(initialView);
            
            // Set initial selected values on segmented controls
            if (toggle) {
                toggle.value = initialView;
            }
            if (colsToggle) {
                colsToggle.value = String(initialCols);
            }
        });

        // Click handler for row click navigation / accordion toggle
        const list = document.getElementById('todoList');
        if (list) {
            // Row click navigation / accordion toggle (ignores interactive targets)
            list.addEventListener('click', handleTodoClick);

            // Action buttons inside rows (avoid inline JS in templates)
            list.addEventListener('click', function (e) {
                const path = getEventPath(e);
                const actionEl = findElementInPath(path, '[data-action]');
                if (!actionEl) return;
                const item = actionEl.closest('.todo-item[data-todo-id]');
                if (!item) return;
                const todoId = item.getAttribute('data-todo-id');
                const action = actionEl.getAttribute('data-action');

                if (action === 'toggle-accordion') {
                    window.toggleTodoAccordion(todoId);
                } else if (action === 'copy-id') {
                    copyTodoId(todoId);
                } else if (action === 'edit') {
                    window.enterInlineEdit(Number(todoId));
                } else if (action === 'save') {
                    window.saveInlineEdit(Number(todoId));
                } else if (action === 'cancel') {
                    window.cancelInlineEdit(Number(todoId));
                } else if (action === 'set-task-size') {
                    const val = actionEl.getAttribute('data-value') || '';
                    updateTodoField(todoId, 'task_size', val);
                }
            });

            // Priority dropdown change (AJAX update + reload)
            list.addEventListener('change', function (e) {
                const path = getEventPath(e);
                const el = path.find(node => node instanceof Element && node.matches('[data-field="priority_class"]'));
                if (!el) return;
                const item = el.closest('.todo-item[data-todo-id]');
                if (!item) return;
                const todoId = item.getAttribute('data-todo-id');
                const value = el.value || '';
                updateTodoField(todoId, 'priority_class', value);
            });
        }
    });
})();

// Handle search - navigate to search results page on Enter
function handleSearch(event) {
    event.preventDefault();
    const searchTerm = document.getElementById('searchInput').value.trim();
    if (searchTerm) {
        window.location.href = `/search?q=${encodeURIComponent(searchTerm)}`;
    }
}

// Persist sort preference and apply it as default when params are missing.
(function () {
    try {
        const url = new URL(window.location.href);
        const hasSort = url.searchParams.has('sort_by') || url.searchParams.has('sort_dir');

        // Save current sort to localStorage (if present in URL or already rendered by server).
        const curBy = "{{ current_sort_by }}";
        const curDir = "{{ current_sort_dir }}";
        if (curBy) localStorage.setItem('tt-sort-by', curBy);
        if (curDir) localStorage.setItem('tt-sort-dir', curDir);

        // If URL does not specify sort, apply saved prefs (without dropping other params).
        if (!hasSort) {
            const savedBy = localStorage.getItem('tt-sort-by');
            const savedDir = localStorage.getItem('tt-sort-dir');
            if (savedBy) url.searchParams.set('sort_by', savedBy);
            if (savedDir) url.searchParams.set('sort_dir', savedDir);
            if (savedBy || savedDir) {
                window.location.replace(url.toString());
            }
        }
    } catch (e) {
        // ignore storage/url errors
    }
})();

// Update todo field via AJAX
async function updateTodoField(todoId, fieldName, fieldValue) {
    const formData = new FormData();
    formData.append(fieldName, fieldValue);
    
    try {
        const response = await fetch(`/api/todos/${todoId}/update`, {
            method: 'POST',
            body: formData,
            redirect: 'manual' // Don't follow redirect, we'll reload the current page instead
        });
        
        // Any success status (2xx) or redirect (3xx) means the update worked
        if (response.ok || response.status === 303 || response.status === 302) {
            // Success - reload the current page to show updated values
            // This preserves query params (like ?status=pending) and keeps us on the list view
            window.location.reload();
        } else {
            console.error('Failed to update todo:', response.statusText);
            // Revert on error by reloading
            window.location.reload();
        }
    } catch (error) {
        console.error('Error updating todo:', error);
        // Revert on error by reloading
        window.location.reload();
    }
}

// Copy todo ID to clipboard
function copyTodoId(todoId) {
    const text = `#${todoId}`;
    navigator.clipboard.writeText(text).then(() => {
        const btn = document.getElementById(`copyBtn${todoId}`);
        if (btn) {
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<svg class="w-3 h-3 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
            btn.title = 'Copied!';
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.title = 'Copy todo ID to clipboard';
            }, 2000);
        }
    }).catch(err => {
        console.error('Failed to copy:', err);
    });
}

// Load topics and tags for autocomplete
let allTags = [];
let allTopics = [];

// Fetch tags
fetch('/api/tags')
    .then(res => res.json())
    .then(tags => {
        allTags = tags.map(t => t.name);
        renderTagSuggestions();
    });

// Fetch topics
fetch('/api/topics')
    .then(res => res.json())
    .then(topics => {
        allTopics = topics;
        const datalist = document.getElementById('topicList');
        topics.forEach(topic => {
            const option = document.createElement('option');
            option.value = topic;
            datalist.appendChild(option);
        });
    });

// Render tag suggestions as clickable chips
function renderTagSuggestions() {
    const container = document.getElementById('tagSuggestions');
    if (!container) return;
    
    container.innerHTML = '<div class="text-xs text-gray-500 w-full">Click to add:</div>';
    
    // Show first 20 tags
    allTags.slice(0, 20).forEach(tagName => {
        const chip = document.createElement('button');
        chip.type = 'button';
        chip.className = 'px-2 py-1 bg-gray-200 text-gray-700 text-xs rounded hover:bg-gray-300 transition';
        chip.textContent = tagName;
        chip.onclick = () => {
            const input = document.getElementById('tagsInput');
            const current = input.value.trim();
            if (current) {
                input.value = current + ', ' + tagName;
            } else {
                input.value = tagName;
            }
        };
        container.appendChild(chip);
    });
}

// Close export menu when clicking outside
document.addEventListener('click', function(event) {
    const exportMenu = document.getElementById('exportMenu');
    const exportButton = event.target.closest('button');
    
    if (exportMenu && !exportMenu.contains(event.target) && 
        (!exportButton || !exportButton.textContent.includes('Export'))) {
        exportMenu.classList.add('hidden');
    }
});
</script>

{% endblock %}

